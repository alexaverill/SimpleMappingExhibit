<html lang="en">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./leaflet/leaflet.css" />
    <script src="./leaflet/leaflet.js"></script>
    <link rel="stylesheet" href="main.css" />
  </head>
  <div id="map"></div>
    <div id="dialog" class="dialog editDialog hidden">
      <div class="dialogbuttons">
        <button onClick="closeDialog()"><img class="icon" src="./assets/save.png" /></button>
        <button onClick="deletePoint()"><img class="icon" src="./assets/delete.png" /></button>
    
    </div>
    <input type="hidden" value="null" id="id"/>
    <div class="dialogInputTitle" id="dialogTitle">
      <input id="title" type="text" class="title" placeholder="Title" />
    </div>
    <div class="image" id="dialogImageContainer">
      <button id="previous" onClick="handlePreviousImage()" class="imageIcon">
        <img class="icon" src="./assets/arrow.png" />
      </button>
      <img id="dialogImage" src="" alt="" />
      <button id="next" onClick="handleNextImage()" class="imageIcon">
        <img class="icon" src="./assets/arrow.png" />
      </button>
      <button id="add" onClick="handleAddImage()" class="addButton">
        <img class="icon" src="./assets/add.png"/>
      </button>
    </div>
    <div class="descriptionTextArea" id="dialogDescription"><textarea id="description" placeholder="Description"></textarea></textarea></div>
  </div>
  <div id="userInstructions" class="userInstructions hide">
    <div id="instructions" class="title">Select the Center of your map</div>
    <div id="subtitle" class="subtitle"></div>
    <div class="userInstructionButtons" id="userInstructionButtons">
    <button onclick="finishStep()">Continue</button>
    </div>
  </div>
  <button class="editButton" onclick="showIntro()">Start</button>
  <dialog id="intro">
    <div class="dialogContent">
      <div class="title">Map Builder.</div>
      <div class="description">
        <div>This is a tool to help you build out a mapping interactive.</div>
        <div>Before you get started make sure that you have:
          <ol>
            <li>Placed all your images are already hosted online somewhere, or in the images folder in the directory.</li>
          </ol>
        </div>
      </div>
      <div class="uploadPrompt">
        If you have already have started an exhibit and want to edit it upload it now: <input type="file" />
      </div>
      <button onClick="advanceToMapCenter()">Continue</button>
    </div>
  </dialog>
    <dialog id="imageAdd" class="imageAddDialog">
    <div class="dialogContent">
      <div class="title">Add Images</div>
      <div class="description">
        <div id="imageList" class="imageList"></div>
        <div class="imageAdd">Add a local image: <input id="imageInput" type="file" onchange="handlePrevewImageSelect()" accept="image/png, image/jpeg, image/jpg"/></div>
        <div class="imageAdd">Link to an Image: <input type="text" id="imageLink" value="https://upload.wikimedia.org/wikipedia/commons/5/53/Ice_Skating-William_Frerichs-1869.jpg"><button onclick="addLinkedImage()">Add</button></button></div>
      </div>
      <div class="buttonBar">
      <button onClick="cancelImageSelect()">Cancel</button> <button onClick="handleImagesSelected()">Save</button>
      </div>
    </div>
  </dialog>
  <dialog id="baseLayerSelection">
    <div class="dialogContent">

    </div>
  </dialog>
    <dialog id="zoomSelection">
    <div class="dialogContent">
      <div class="title">Define zoom levels</div>
      <div class="description">
        The minimum zoom level is how far out a person can zoom, this should be as close to the edges of your bounding box as possible. The maximum zoom level is how close people can zoom into the map. 
      </div>
      <div>
        <button onclick="advanceToSelectZoom()">Continue</button>
      </div>
    </div>
  </dialog>

    <dialog id="boundsSelectionDialog">
        <div class="dialogContent">
      <div class="title">Select Map Bounds</div>
      <div class="description">Select the outer limits that you want people to be able to drag the map to. Your bounding box should include some padding around your points to ensure that people can see all your points. When in doubt go larger. 
      <div>
        <button onClick="skipBounds()">Skip</button>
        <button onClick="advanceToBounds()">Select Bounds</button>
      </div>
    </div>
  </dialog>
    <dialog id="completedMap">
        <div class="dialogContent">
      <div class="title">Map Complete!</div>
      <div class="description">
        You have completed your map, you can now download the data file and place it nex to the index.html file. Ensure all the images you selected are in a images folder that is next to the index.html file. 
      <div>
        <button onClick="closeComplete()">Close </button>
        <a href="" id="downloadLink" class="download">Download</button>
      </div>
    </div>
  </dialog>
  <div
    id="dialogBackground"
    class="dialogBackground"
    onclick="handleBackgroundClick()"
  ></div>

  <script>
    const steps = {
      Center: 1,
      Points: 2,
      Editing: 3,
      Bounds: 4,
            MinZoomLevel: 5,
            MaxZoomLevel:6
    };
    let currentStep = steps.Center;
    let currentMapCenter = null;
    let centerMarker = null;
    let map;
    let currentImage = 0;
    let content = null;
    let dialogTitle = document.getElementById("dialogTitle");
    let dialogImage = document.getElementById("dialogImage");
    let dialogDescription = document.getElementById("dialogDescription");
    let isClicked = false;
    let startPos = null;
    let endPos = null;
    let rectangle = null;
    let pointsOfInterest = null;
    let points = [];
    let pointLatLng = null;
    let newPointRef = null;
     let imageList = [];
     let bounds;
     let originalZoomlevel = null;
     let boundsRect = null;
     let maxZoomLevel = null;
     let minZoomLevel = null;
    const showIntro = () => {
      document.getElementById("intro").showModal();
    };
    const handleResetBounds = ()=>{
      map.removeLayer(boundsRect);
      isClicked =false;
      map.setZoom(originalZoomlevel);
    }
    const advanceToBounds = () =>{
      isClicked = false;
      document.getElementById("boundsSelectionDialog").close();
      let resetBtn = document.createElement('button');
      resetBtn.onclick=handleResetBounds;
      resetBtn.appendChild(document.createTextNode("Reset"));
      document.getElementById("userInstructionButtons").prepend(resetBtn);
      setInstructions("Click to start drawing a boundary box.", "");
      currentStep = steps.Bounds;
    }
    const advanceToMapCenter = () => {
      document.getElementById("intro").close();
      document.getElementById("userInstructions").classList.remove("hide");
      setInstructions(
        "Set the center of the map.",
        "This sets the maps default location."
      );
    };
    const advanceToSelectZoom = ()=>{
      currentStep = steps.MinZoomLevel;
      document.getElementById("userInstructionButtons").innerHTML='';
            document.getElementById("zoomSelection").close();
      let resetBtn = document.createElement('button');
      resetBtn.onclick=finishStep;
      resetBtn.appendChild(document.createTextNode("Set and Continue"));
      document.getElementById("userInstructionButtons").prepend(resetBtn);
      setInstructions("How far out can users zoom?", "");
    }
    const advanceToSelectMaxZoom = ()=>{
      console.log("Max Zoom!");
      currentStep = steps.MaxZoomLevel;
            document.getElementById("userInstructionButtons").innerHTML='';
      let resetBtn = document.createElement('button');
      resetBtn.onclick=finishStep;
      resetBtn.appendChild(document.createTextNode("Set and Continue"));
      document.getElementById("userInstructionButtons").prepend(resetBtn);
      setInstructions("How far in can users zoom in?", "");
    }
    const handleComplete = ()=>{
      console.log("COMPLETE");
      let cleanedPoints = points.map(point =>{
        return {
          id:point.id,
          title:point.title,
          description:point.description,
          latitude:point.latitude,
          longitude:point.longitude,
          images:point.image
        }
      })
      let mapObject = {
        mapCenter:currentMapCenter,
        minZoom:minZoomLevel,
        maxZoom:maxZoomLevel,
        pointsOfInterest:cleanedPoints
      }
      let jsonString = JSON.stringify(mapObject);
      var data = new Blob([jsonString], {type: 'application/json'});

      let textFile = window.URL.createObjectURL(data);
      document.getElementById("downloadLink").href=textFile;
      console.log(jsonString);
      document.getElementById("completedMap").showModal();
    }
    const addLinkedImage = ()=>{
      let link = document.getElementById("imageLink");
      buildImagePreview(link.value);
      link.value='';
    }
    const handlePrevewImageSelect =(e)=>{
      let files = document.getElementById("imageInput").files;
      console.log(files);
      let path =  `./images/${files[0].name}`;
      buildImagePreview(path);
    }
    const buildImagePreview = (imgPath)=>{
      let parent = document.getElementById("imageList");
      let imageContainer = document.createElement('div');
      imageContainer.id = document.getElementsByClassName('previewImageContainer').length; //want to be able to delete it easily
      imageContainer.className = "previewImageContainer"
      imageContainer.setAttribute("image",imgPath);
      let image = document.createElement('img');
      image.src =imgPath;
      let deleteBtn = document.createElement('button');
      deleteBtn.className="imageDeleteBtn";
      let deleteBtnIcon = document.createElement('img')
      deleteBtnIcon.src = "./assets/delete.png";
      deleteBtn.appendChild(deleteBtnIcon);
      deleteBtn.onclick = ()=>{console.log(`Delete image: ${imageContainer.id}`); document.getElementById(imageContainer.id).remove()};
      imageContainer.appendChild(image);
      imageContainer.appendChild(deleteBtn);
      parent.appendChild(imageContainer);

    }
    const handleAddImage = ()=>{
      console.log(imageList);
      if(imageList.length>0){
        console.log("NEED to add images to dialog");
        imageList.map((image)=>{
          buildImagePreview(image.image);
        })
      }
      document.getElementById("imageAdd").showModal(); 
    }
    const cancelImageSelect = () =>{
      document.getElementById("imageAdd").close(); 
    }
    const handleImagesSelected = ()=>{
     
      let images = document.getElementsByClassName("previewImageContainer");
      for(let image of images){
        let imageObj = {image:image.getAttribute("image")}
        imageList.push(imageObj);
      }
      document.getElementById("imageLink").value='';
      document.getElementById("imageList").innerHTML = '';
      dialogImage.src = imageList[currentImage].image;
      document.getElementById("imageAdd").close(); 
    }
    const setInstructions = (title, subtitle) => {
      document.getElementById("instructions").innerText = title;
      document.getElementById("subtitle").innerText = subtitle;
    };
    const setCurrentLatLang = () => {
      addCenterMarker();
      map.setView(currentMapCenter);
    };
    const advanceToPoints = () => {
      currentStep = steps.Points;
      setInstructions("Add points", "Click to create points");
    };

    const addNewPoint = (latlng) => {
      document.getElementById("id").value = 'null';
      currentStep = steps.Editing;
      pointLatLng = latlng;
      console.log(pointLatLng);
      let point = L.marker(latlng).addTo(map);
      point.on("click",(e)=>{
        console.log(e);
        pointClicked(e.latlng.lat,e.latlng.lng);
      });
      newPointRef = point;
      document.getElementById("dialog").classList.toggle("visible");
    };
    const addCenterMarker = () => {
      if (centerMarker && map) {
        map.removeLayer(centerMarker);
      }
      var myIcon = L.icon({
        iconUrl: "assets/flag.svg",
        iconSize: [40, 40],
        iconAnchor: [11, 30],
        popupAnchor: [-3, -76],
        shadowSize: [68, 95],
        shadowAnchor: [22, 94],
      });

      centerMarker = L.marker(currentMapCenter, { icon: myIcon }).addTo(map);
    };
    const finishStep = () => {
      console.log(currentStep);
      switch (currentStep) {
        case steps.Center:
          advanceToPoints();
          break;
        case steps.Points:
          currentStep = steps.Bounds;
          document.getElementById("boundsSelectionDialog").showModal();
          break;
        case steps.Bounds:
          currentStep = steps.MinZoomLevel;
          document.getElementById("zoomSelection").showModal();
          break;
        case steps.MinZoomLevel:
          minZoomLevel = map.getZoom();
          currentStep = steps.MaxZoomLevel;
          advanceToSelectMaxZoom();
          break;
        case steps.MaxZoomLevel:
          maxZoomLevel = map.getZoom();
          handleComplete();
          break;
      }
    };

    const initializeMap = (
      startCoordinates = [0, 0],
      zoomLevel = 3,
      maxZoomLevel = 15,
      minZoomLevel = 3,
      zoomPosition = "bottomright"
    ) => {
      map = L.map("map").setView(startCoordinates, zoomLevel);

      map.zoomControl.remove();
      if (minZoomLevel !== maxZoomLevel) {
        L.control
          .zoom({
            position: zoomPosition,
          })
          .addTo(map);
      }
      let osm = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 15,
        minZoom: 1,
        zoomControl: false,
        attribution:
          '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      });
      let openTopo = L.tileLayer(
        "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 17,
          attribution:
            'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
        }
      );
      let openSatellite = L.tileLayer(
        "https://tiles.stadiamaps.com/tiles/alidade_satellite/{z}/{x}/{y}{r}.{ext}",
        {
          minZoom: 0,
          maxZoom: 20,
          attribution:
            '&copy; CNES, Distribution Airbus DS, © Airbus DS, © PlanetObserver (Contains Copernicus Data) | &copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          ext: "jpg",
        }
      );
      osm.addTo(map);
      var baseMaps = {
        "Open Street Map": osm,
        "Open Topography": openTopo,
        Satellite: openSatellite,
      };
      var overlays = {};
      L.control
        .layers(baseMaps, overlays, { position: "bottomright" })
        .addTo(map);
      map.on("click", (e) => {
        console.log(currentStep)
        if (currentStep == steps.Center) {
          currentMapCenter = e.latlng;
          setCurrentLatLang();
          return;
        }
        if (currentStep == steps.Points) {
          addNewPoint(e.latlng);
        }
        console.log(`Clicked at ${e.latlng} Zoom Level:${map.getZoom()} ${currentStep}`);
        if(currentStep == steps.Bounds && !isClicked){
          originalZoomlevel = map.getZoom();
          startPos = e.latlng
      }
      if(currentStep == steps.Bounds && isClicked){
            bounds = L.latLngBounds(startPos,e.latlng);
            console.log(bounds);
            map.setMaxBounds(bounds);
            map.flyToBounds(bounds);
      }  
        
        isClicked = !isClicked;
      });
      map.on("mousemove", (e) => {
        if (currentStep !== steps.Bounds) {
          return;
        }
        if (isClicked) {
          console.log(`Moved: ${e.latlng}`);
          bounds = L.latLngBounds(startPos, e.latlng);
          endPos = e.latlng;
          let previousRects = document.getElementsByClassName("zoomRect");
          if (previousRects) {
            for (let element of previousRects) {
              console.log(element);
              setInstructions("Click to select other corner of your bounds", "");
              element.remove();
            }
          }
          boundsRect = L.rectangle(bounds, {
            color: "#FFFF00",
            weight: 1,
            className: "zoomRect",
          }).addTo(map);
          
          
        }
      });
    };
    const initializePointsOfInterest = (points) => {
      points.map((point) => {
        var marker = L.marker([point.latitude, point.longitude]).addTo(map);
        marker.on("click", () => {
          poiClicked(point.id);
        });
      });
    };
    const handleBackgroundClick = () => {
      closeDialog();
    };
    const handlePreviousImage = () => {
      currentImage =
        currentImage > 0 ? currentImage - 1 : imageList.length - 1;
      dialogImage.opacity = 0;
      dialogImage.src = imageList[currentImage].image;
      dialogImage.opacity = 1;
    };
    const handleNextImage = () => {
      currentImage = (currentImage + 1) % imageList.length;
      dialogImage.opacity = 0;
      dialogImage.src = imageList[currentImage].image;
      dialogImage.opacity = 1;
    };
    const deletePoint = ()=>{
      let currentid = document.getElementById("id").value;
      if(currentid ==='null'){
        map.removeLayer(newPointRef);
      }else{
        let index = points.findIndex(point =>point.id ==currentid);
        map.removeLayer(points[index].pointRef);
        points.splice(index,1);
      }
      document
        .getElementById("dialogBackground")
        .classList.remove("dialogBackgroundVisible");
      document.getElementById("dialog").classList.remove("visible");
      document.getElementById("title").value = '';
      document.getElementById("description").value = '';
      document.getElementById("id").valu='null';
      currentStep = steps.Points;
    }
    const closeDialog = () => {
      let currentid = document.getElementById("id").value;
      let title = document.getElementById("title").value;
      let description = document.getElementById("description").value;
      if(currentid === 'null'){
        console.log("Add New Point");
        let id=points.length;
        let newPoint = {
          title,
          description,
          id,
          latitude:pointLatLng.lat,
          longitude:pointLatLng.lng,
          pointRef:newPointRef,
          images:imageList
        }
        console.log(newPoint);
        points.push(newPoint);
      }else{
        console.log(points);
        console.log(currentid);
        let index = points.findIndex(point =>point.id ==currentid);
        console.log(index);
        points[index].title = title;
        points[index].description = description;
        points[index].images = imageList;
      }
      document
        .getElementById("dialogBackground")
        .classList.remove("dialogBackgroundVisible");
      document.getElementById("dialog").classList.remove("visible");
      document.getElementById("title").value = '';
      document.getElementById("description").value = '';
      document.getElementById("id").value = 'null';
      newPointRef = null;
      imageList = [];
      dialogImage.src = '';
      currentStep =steps.Points;
    };
    const pointClicked =(lat,lng)=>{
      let point = points.find(point=>point.latitude ===lat && point.longitude ===lng);
      setDialogContent(point);
      document.getElementById("dialog").classList.toggle("visible");
    }
    const setDialogImages = (imageList) =>{

    }
    const setDialogContent = (point) => {
      currentImage = 0;
      imageList = [];
      content = point
      let previousImgBtn = document.getElementById("previous");
      let nextImgBtn = document.getElementById("next");
      imageList = content.images;
      if (imageList.length <= 1) {
        if (!previousImgBtn.classList.contains("hide")) {
          previousImgBtn.classList.add("hide");
        }
        if (!nextImgBtn.classList.contains("hide")) {
          nextImgBtn.classList.add("hide");
        }
      } else {
        nextImgBtn.classList.remove("hide");
        previousImgBtn.classList.remove("hide");
      }
      document.getElementById("id").value = point.id;
      document.getElementById("title").value = point.title;
      document.getElementById("description").value = point.description;
      if(imageList.length>0){
        dialogImage.src = imageList[currentImage]?.image;
      }
    };
    const load = async () => {
      let data = await fetch("./data.json");
      let json = await data.json();
      pointsOfInterest = json.pointsOfInterest;
      initializePointsOfInterest(pointsOfInterest);
    };
    initializeMap();

    //document.getElementById("intro").showModal()
  </script>
</html>
